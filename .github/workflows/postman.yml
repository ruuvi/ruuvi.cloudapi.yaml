name: Publish API to Postman and run tests

on:
  workflow_dispatch:

jobs:
  postman:
    runs-on: ubuntu-latest

    env:
      POSTMAN_API_KEY: ${{ secrets.POSTMAN_API_KEY }}
      POSTMAN_API_ID: ${{ vars.POSTMAN_API_ID }}
      POSTMAN_SCHEMA_ID: ${{ vars.POSTMAN_SCHEMA_ID }}
      POSTMAN_SCHEMA_FILE: ${{ vars.POSTMAN_SCHEMA_FILE }}
      POSTMAN_API_VERSION_ID: ${{ vars.POSTMAN_API_VERSION_ID }}
      POSTMAN_COLLECTION_UID: ${{ vars.POSTMAN_COLLECTION_UID }}
      POSTMAN_MONITORS: ${{ vars.POSTMAN_MONITORS }

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Bundle OpenAPI (User API)
        run: |
          mkdir -p userapi
          npx -y @redocly/cli@latest bundle \
            userapi/openapi.yaml \
            -o userapi/bundle.yaml

      - name: Update Postman schema from OpenAPI file
        run: |
          # Read and JSON-escape the OpenAPI file
          CONTENT=$(jq -Rs . < userapi/bundle.yaml)

          curl -sS -X PUT \
            "https://api.getpostman.com/apis/${POSTMAN_API_ID}/schemas/${POSTMAN_SCHEMA_ID}/files/${POSTMAN_SCHEMA_FILE}" \
            -H "X-Api-Key: ${POSTMAN_API_KEY}" \
            -H "Accept: application/vnd.api.v10+json" \
            -H "Content-Type: application/json" \
            -d "{\"content\": ${CONTENT}}"

    