name: PR Lint

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  check-linked-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: read
      pull-requests: read
    steps:
      - name: Check if PR is linked to an issue
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const prBody = pr.body || '';
            
            // Look for issue references in PR body (e.g., #123, fixes #123, closes #123)
            const issuePattern = /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s+#(\d+)|#(\d+)/gi;
            const matches = [...prBody.matchAll(issuePattern)];
            
            if (matches.length === 0) {
              core.setFailed('❌ This PR is not linked to any issue. Please link it to exactly one issue using keywords like "fixes #123" or "closes #123" in the PR description.');
              return;
            }
            
            // Extract unique issue numbers
            const issueNumbers = [...new Set(matches.map(match => match[3] || match[4]).filter(Boolean))];
            console.log(`Found linked issues: ${issueNumbers.join(', ')}`);
            
            // Enforce 1:1 PR to issue relationship
            if (issueNumbers.length > 1) {
              core.setFailed(`❌ This PR is linked to ${issueNumbers.length} issues (${issueNumbers.join(', ')}). Please link it to exactly one issue.`);
              return;
            }
            
            const issueNumber = issueNumbers[0];
            
            try {
              // Fetch the issue using GraphQL to get the type field
              const query = `
                query($owner: String!, $repo: String!, $number: Int!) {
                  repository(owner: $owner, name: $repo) {
                    issue(number: $number) {
                      number
                      title
                      issueType
                    }
                  }
                }
              `;
              
              const result = await github.graphql(query, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                number: parseInt(issueNumber)
              });
              
              const issue = result.repository.issue;
              
              if (!issue) {
                core.setFailed(`❌ Issue #${issueNumber} not found.`);
                return;
              }
              
              if (!issue.issueType) {
                core.setFailed(`❌ Issue #${issueNumber} does not have a type set. Please set an issue type (bug, feature, question, etc.) on the linked issue.`);
                return;
              }
              
              console.log(`✅ PR is properly linked to issue #${issueNumber} with type: ${issue.issueType}`);
              
            } catch (error) {
              core.setFailed(`❌ Error fetching issue #${issueNumber}: ${error.message}`);
            }
